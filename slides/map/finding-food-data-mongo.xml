<slide>
<title>Querying our database</title>

<div effect="fade-out">
<example><![CDATA[<?php
header('Content-type: text/plain');
$m = new Mongo( 'mongodb://localhost:27017' );
$d = $m->selectDb( 'poi' );

$wantedD = isset($_GET['d']) ? $_GET['d']: 1;

$query = array( 'tags_indexed.k' => 'cuisine', 'tags_indexed.v' => $_GET['cuisine'] );
if ( $_GET['cuisine'] == 'all' )
{
    $query = array( 'tags_indexed.k' => 'amenity', 'tags_indexed.v' => 'restaurant' );
}

$s = $d->command(
    array(
        'geoNear' => 'poi',
		'spherical' => true,
        'near' => array( $_GET['lat'], $_GET['lon'] ),
        'num' => 1000,
        'maxDistance' => $wantedD / 6371.01, // km to Â°
        'query' => $query,
    )
);
echo "lat\tlon\ttitle\tdescription\r\n";
foreach( $s['results'] as $res) {
    if (isset($res['obj']['name'] ) )
    {
        echo $res['obj']['loc'][0], "\t", $res['obj']['loc'][1], "\t",
		$res['obj']['name'], "\t",
		sprintf('real: %.4f mongo: %.4f',
			$e,
			$res['dis'] * 6371.01
		), " km away\r\n";
    }
}
]]></example>
</div>
<div effect="fade-in-out">
<blurb>MongoDB's 2D index</blurb>
<example><![CDATA[
db.poi.ensureIndex( { poi : '2d' } );

$s = $d->command(
    array(
        'geoNear' => 'poi',
        'spherical' => true,
        'near' => array( $_GET['lon'], $_GET['lat'] ),
        'num' => 10000,
        'maxDistance' => $wantedD / 6371.01, // km to radians
        'query' => $query,
    )
);
]]></example>
<list>
	<bullet>%spherical => true,% for spherical Earth calculations</bullet>
</list>
</div>
</slide>
